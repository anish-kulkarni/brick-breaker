
///////////// Mutation Pseudo-code /////////////

int in_connection_pool(int x,int y)
{
    for(i from 0 to next_gen.connection_gene_pool.size())
    {
        if(next_gen.connection_gene_pool[i].start==x && next_gen.connection_gene_pool[i].end==y)
            return next_gen.connection_gene_pool[i].innovation_number
    }

    return 0
}

int in_connection_pool(int x)
{
    for(i from 0 to next_gen.connection_gene_pool.size())
    {
        if(next_gen.node_gene_pool[i].broken_connection_number==x)
            return next_gen.node_gene_pool[i].innovation_number
    }

    return 0
}

void add_connection_gene_pool(int x, int y, int innovation_number)
{
    next_gen.connection_gene_pool.append(x,y,innoavtion_number)
}

void add_node_gene_pool(int x, int innovation_number)
{
    next_gen.node_gene_pool.append(x,innoavtion_number)
}

void mutate_weight(int members, vector<int> mutate[])
{
    for(i from 0 to members)
    {
        /// Random select Connection to Mutrate
        next_gen.offspring.append(curr_gen.offspring[mutate[i]])
        int x = random(0,next_gen.offspring.end().genome.connection_genes.size())

        /// Mutate connection weight
        if(probability(probability_weight_tweak))
            if(probability(0.5)) /// Tweak Weight
                next_gen.offspring.end().genome.connection_genes(x).weight += delta_weight
            else
                next_gen.offspring.end().genome.connection_genes(x).weight -= delta_weight
        else
            next_gen.offspring.end().genome.connection_genes(x).weight = random(-weight_limit,weight_limit) /// Random Weight assign
    }
}

void mutate_gene(int members, vector<int> mutate[])
{
    for(i from 0 to members)
    {
        /// Random select nodes for connection
        next_gen.offspring.append(curr_gen.offspring[mutate[i]])
        int x,y,n = next_gen.offspring.end().genome.node_genes.size()
        for(;;)
        {
            for(;;)
            {
                x = random(0,n)
                if(next_gen.offspring.end().genome.node_genes[x].type != 1)
                    break;
            }
            for(;;)
            {
                y = random(0,n)
                if(y!=x&&next_gen.offspring.end().genome.node_genes[x].type != -1)
                    break
            }
            if((x,y) not in next_gen.offspring.end().genome.connection_genes())
                break
        }

        ///  connection
        int innovation = in_connection_pool(x,y);
        if(innovation>0)
        {
            next_gen.offspring.end().genome.connection_genes.push_back(new connection_gene(x,y,random(-weight_limit,weight_limit),innovation))
        }
        else
        {
            connection_global_innovation_number++;
            next_gen.offspring.end().genome.connection_genes.push_back(new connection_gene(x,y,random(-weight_limit,weight_limit),connection_global_innovation_number))
            add_connection_gene_pool(x,y,connection_global_innovation_number)
        }

    }
}

void mutate_gene_weight(int members, vector<int> mutate[])
{
    for(i from 0 to members)
    {
        /// Random select nodes for connection
        next_gen.offspring.append(curr_gen.offspring[mutate[i]])
        int x,y,n = next_gen.offspring.end().genome.node_genes.size()
        for(;;)
        {
            for(;;)
            {
                x = random(0,n)
                if(next_gen.offspring.end().genome.node_genes[x].type != 1)
                    break;
            }
            for(;;)
            {
                y = random(0,n)
                if(y!=x&&next_gen.offspring.end().genome.node_genes[x].type != -1)
                    break
            }
            if((x,y) not in next_gen.offspring.end().genome.connection_genes())
                break
        }

        /// Create connection
        int innovation = in_connection_pool(x,y);
        if(innovation>0)
        {
            next_gen.offspring.end().genome.connection_genes.push_back(new connection_gene(x,y,random(-weight_limit,weight_limit),innovation))
        }
        else
        {
            connection_global_innovation_number++;
            next_gen.offspring.end().genome.connection_genes.push_back(new connection_gene(x,y,random(-weight_limit,weight_limit),connection_global_innovation_number))
            add_connection_gene_pool(x,y,connection_global_innovation_number)
        }

        /// Mutate weight

        /// Random connection
        int x = random(0,next_gen.offspring.end().genome.connection_genes.size())

        /// Mutate connection weight
        if(probability(probability_weight_tweak))
            if(probability(0.5)) /// Tweak Weight
                next_gen.offspring.end().genome.connection_genes(x).weight += delta_weight
            else
                next_gen.offspring.end().genome.connection_genes(x).weight -= delta_weight
        else
            next_gen.offspring.end().genome.connection_genes(x).weight = random(-weight_limit,weight_limit) /// Random Weight assign


    }
}

void mutate_node(int members, vector<int> mutate[])
{
    for(i from 0 to members)
    {
        /// Random select connection to Mutate
        next_gen.offspring.append(curr_gen.offspring[mutate[i]])
        int x
        x = random(0,next_gen.offspring.end().connection_genes.size())

        node input = next_gen.offspring.end().connection_genes(x).input
        node output = next_gen.offspring.end().connection_genes(x).output
        double weight = next_gen.offspring.end().connection_genes(x).weight

        /// Create new node with innovation number

        int innovation = in_node_pool(next_gen.offspring.end().connection_genes(x).innovation_number)
        if(innovation>0)
        {
            next_gen.offspring.end().node_genes.append(new node_gene(0,innovation_number)
            innovation = in_connection_pool(next_gen.offspring.end().connection_genes(x).input,next_gen.offspring.end().connection_genes(x).output)
        }
        else
        {
            global_node_innovation_number++;
            next_gen.offspring.end().node_genes.append(new node_gene(0,global_node_innovation_number)
            add_node_gene_pool(next_gen.offspring.end().connection_genes(x).innovation_number,global_node_innovation_number)
        }

        /// Add node to connection
        next_gen.offspring.end().connection_genes(x).enabled = false
        node k = next_gen.offspring.end().node_genes.end()

        if(innovation>0)
        {
            next_gen.offspring.end().genome.connection_genes.push_back(new connection_gene(input,k,1,innovation))
        }
        else
        {
            connection_global_innovation_number++;
            next_gen.offspring.end().genome.connection_genes.push_back(new connection_gene(input,k,1,connection_global_innovation_number))
            add_connection_gene_pool(input,k,connection_global_innovation_number)
        }

        if(innovation>0)
        {
            next_gen.offspring.end().genome.connection_genes.push_back(new connection_gene(k,output,weight,innovation+1))
        }
        else
        {
            connection_global_innovation_number++;
            next_gen.offspring.end().genome.connection_genes.push_back(new connection_gene(k,output,weight,connection_global_innovation_number))
            add_connection_gene_pool(input,k,connection_global_innovation_number)
        }
    }
}

void mutate_node_weight(int members, vector<int> mutate[])
{
    for(i from 0 to members)
    {
        /// Random select connection to Mutate
        next_gen.offspring.append(curr_gen.offspring[mutate[i]])
        int x
        x = random(0,next_gen.offspring.end().connection_genes.size())

        node input = next_gen.offspring.end().connection_genes(x).input
        node output = next_gen.offspring.end().connection_genes(x).output
        double weight = next_gen.offspring.end().connection_genes(x).weight

        /// Create new node with innovation number

        int innovation = in_node_pool(next_gen.offspring.end().connection_genes(x).innovation_number)
        if(innovation>0)
        {
            next_gen.offspring.end().node_genes.append(new node_gene(0,innovation_number)
            innovation = in_connection_pool(next_gen.offspring.end().connection_genes(x).input,next_gen.offspring.end().connection_genes(x).output)
        }
        else
        {
            global_node_innovation_number++;
            next_gen.offspring.end().node_genes.append(new node_gene(0,global_node_innovation_number)
            add_node_gene_pool(next_gen.offspring.end().connection_genes(x).innovation_number,global_node_innovation_number)
        }

        /// Add node to connection
        next_gen.offspring.end().connection_genes(x).enabled = false
        node k = next_gen.offspring.end().node_genes.end()

        if(innovation>0)
        {
            next_gen.offspring.end().genome.connection_genes.push_back(new connection_gene(input,k,1,innovation))
        }
        else
        {
            connection_global_innovation_number++;
            next_gen.offspring.end().genome.connection_genes.push_back(new connection_gene(input,k,1,connection_global_innovation_number))
            add_connection_gene_pool(input,k,connection_global_innovation_number)
        }

        if(innovation>0)
        {
            next_gen.offspring.end().genome.connection_genes.push_back(new connection_gene(k,output,weight,innovation+1))
        }
        else
        {
            connection_global_innovation_number++;
            next_gen.offspring.end().genome.connection_genes.push_back(new connection_genes(k,output,weight,connection_global_innovation_number))
            add_connection_gene_pool(input,k,connection_global_innovation_number)
        }

        /// Mutate weight

        /// Random connection
        int x = random(0,next_gen.offspring.end().genome.connection_genes.size())

        /// Mutate connection weight
        if(probability(probability_weight_tweak))
            if(probability(0.5)) /// Tweak Weight
                next_gen.offspring.end().genome.connection_genes(x).weight += delta_weight
            else
                next_gen.offspring.end().genome.connection_genes(x).weight -= delta_weight
        else
            next_gen.offspring.end().genome.connection_genes(x).weight = random(-weight_limit,weight_limit) /// Random Weight assign

    }
}

void mutaion_species(vector<int> mutate[],int offspring)
{
    int x,members = mutate.size()
    vector<int> to_mutate
    for(;;)
    {
        /// Select Organisms to be Mutated Randomly
        x = random(0,members)
        if(x not in to_mutate)
        {
            to_mutate.append(x)
            if(to_mutate.size()>= offspring*100 / percent_mutate)
                break
        }

        /// Mutate Oragnism weights
        int x1 = to_mutate.size()*100 / percent_weight_mutation
        vector<int> to_mutate_weights
        for(i from 0 to x1-1)
        {
            to_mutate_weights.append(to_mutate.pull(i))
        }
        mutate_weight(to_mutate_weights.size(), to_mutate_weights[])

        /// Mutate Orgamism by Adding Genes
        int x2 = to_mutate.size()*100 / percent_gene_mutation
        vector<int> to_mutate_genes
        for(i from x1 to x2-1)
        {
            to_mutate_genes.append(to_mutate.pull(i))
        }
        mutate_gene(to_mutate_genes.size(), to_mutate_genes[])

        /// Mutate Organism by Adding Node
        int x3 = to_mutate.size()*100 / percent_node_mutation
        vector<int> to_mutate_nodes
        for(i from x2 to x3-1)
        {
            to_mutate_nodes.append(to_mutate.pull(i))
        }
        mutate_node(to_mutate_nodes.size(), to_mutate_nodes[])

        /// Combined Mutation Pending

        /// Mutate Orgamism by Adding Genes and then mutate weights
        int x4 = to_mutate.size()*100 / percent_gene_mutation
        vector<int> to_mutate_genes_weights
        for(i from x3 to x4-1)
        {
            to_mutate_genes_weights.append(to_mutate.pull(i))
        }
        mutate_gene_weight(to_mutate_genes_weights.size(), to_mutate_genes_weights[])

        /// Mutate Organism by Adding Node and then mutate weights
        vector<int> to_mutate_nodes_weights
        for(i from x4 to members-1)
        {
            to_mutate_nodes_weights.append(to_mutate.pull(i))
        }
        mutate_node_weight(to_mutate_nodes_weights.size(), to_mutate_nodes_weights[])
}

/// This is the main_mutaion function which will be called for mutation
void mutation()
{
    for(i from 0 to curr_gen.species.size())
    {
        mutaion_species(curr_gen.species[i].individual[],curr_gen.species[i].permitted_offspring)
    }
}
